<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Wars 2 Tracker - Profit Calculator</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Menú Lateral -->
    <aside class="sidebar">
        <div class="logo">
            <h1>GW2 Tracker</h1>
        </div>
        <nav class="menu">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="profit-calculator.html" class="active">Profit Calculator</a></li>
                <li><a href="sniper.html">Sniper</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Selector de Idioma -->
    <div class="language-selector">
        <button class="language-btn" onclick="changeLanguage('en')">English</button>
        <button class="language-btn" onclick="changeLanguage('es')">Español</button>
    </div>

    <!-- Contenido Principal -->
    <main class="main-content">
        <section id="profit-calculator" class="section">
            <h2 id="profit-title">Profit Calculator</h2>
            <table class="modern-table">
                <thead>
                    <tr>
                        <th id="material1-header">Material 1</th>
                        <th id="material2-header">Material 2</th>
                        <th id="dust-header">Dust</th>
                        <th id="stone-header">Philosopher's Stone</th>
                        <th id="result-header">Resulting Item</th>
                        <th id="combined-header">Combined Value</th>
                        <th id="profit-header">Profit</th>
                    </tr>
                </thead>
                <tbody id="profit-table">
                    <!-- Fila generada dinámicamente -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
        let currentLanguage = 'en'; // Idioma por defecto
        const materials = [
            { id: 24294, quantity: 50 }, // Material 1
            { id: 24295, quantity: 1 }, // Material 2
            { id: 24277, quantity: 5 },  // Polvo
            { id: 20796, quantity: 5 }   // Piedra Filosofal
        ];
        const resultingItemId = 24295; // ID del objeto resultante
        const resultingItemQuantity = 6; // Cantidad de objetos resultantes

        // Cambiar idioma y actualizar el contenido
        function changeLanguage(lang) {
            currentLanguage = lang;
            if (lang === 'en') {
                document.getElementById('profit-title').innerText = 'Profit Calculator';
                document.getElementById('material1-header').innerText = 'Material 1';
                document.getElementById('material2-header').innerText = 'Material 2';
                document.getElementById('dust-header').innerText = 'Dust';
                document.getElementById('stone-header').innerText = "Philosopher's Stone";
                document.getElementById('result-header').innerText = 'Resulting Item';
                document.getElementById('combined-header').innerText = 'Combined Value';
                document.getElementById('profit-header').innerText = 'Profit';
            } else if (lang === 'es') {
                document.getElementById('profit-title').innerText = 'Calculadora de Beneficio';
                document.getElementById('material1-header').innerText = 'Material 1';
                document.getElementById('material2-header').innerText = 'Material 2';
                document.getElementById('dust-header').innerText = 'Polvo';
                document.getElementById('stone-header').innerText = 'Piedra Filosofal';
                document.getElementById('result-header').innerText = 'Objeto Resultante';
                document.getElementById('combined-header').innerText = 'Valor Combinado';
                document.getElementById('profit-header').innerText = 'Beneficio';
            }
            fetchProfitData(); // Recarga los datos con el idioma seleccionado
        }

        // Obtener y mostrar los datos de los objetos y precios
        async function fetchProfitData() {
            try {
                const ids = materials.map(mat => mat.id).concat(resultingItemId);
                const itemDetails = await fetch(`https://api.guildwars2.com/v2/items?ids=${ids.join(",")}&lang=${currentLanguage}`);
                const items = await itemDetails.json();
                const itemPrices = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${ids.join(",")}`);
                const prices = await itemPrices.json();

                const itemsMap = {};
                items.forEach(item => {
                    itemsMap[item.id] = {
                        name: item.name,
                        icon: item.icon
                    };
                });

                const pricesMap = {};
                prices.forEach(price => {
                    pricesMap[price.id] = {
                        buy: price.buys.unit_price,
                        sell: price.sells.unit_price
                    };
                });

                populateProfitTable(itemsMap, pricesMap); // Llama a la función para poblar la tabla
            } catch (error) {
                console.error("Error fetching profit data:", error); // Manejo de errores
            }
        }

        // Función para poblar la tabla con los datos
        function populateProfitTable(itemsMap, pricesMap) {
            const tableBody = document.getElementById("profit-table");
            tableBody.innerHTML = ""; // Limpia la tabla antes de agregar las nuevas filas

            // Calculamos el valor combinado de los materiales
            const combinedValue = materials.reduce((sum, mat) => {
                return sum + (pricesMap[mat.id]?.buy || 0) * mat.quantity;
            }, 0);

            // Precio de venta del objeto resultante (multiplicamos por 7 unidades)
            const resultingSellPrice = (pricesMap[resultingItemId]?.sell || 0);
            const totalResultingValue = resultingSellPrice * resultingItemQuantity; // Considerando 7 unidades
            const profit = totalResultingValue - combinedValue; // Calculando el beneficio

            const row = `
                <tr>
                    ${materials.map(mat => `
                        <td>
                            <img src="${itemsMap[mat.id]?.icon}" alt="${itemsMap[mat.id]?.name}" class="item-icon">
                            <span>x${mat.quantity}</span>
                        </td>
                    `).join("")}
                    <td>
                        <img src="${itemsMap[resultingItemId]?.icon}" alt="${itemsMap[resultingItemId]?.name}" class="item-icon">
                        <span>${itemsMap[resultingItemId]?.name}</span>
                    </td>
                    <td>${formatCurrency(combinedValue)}</td>
                    <td style="color: ${profit >= 0 ? 'green' : 'red'}; font-weight: bold;">
                        ${formatCurrency(profit)}
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        }

        // Función para formatear la moneda
        function formatCurrency(value) {
            const gold = Math.floor(value / 10000);
            const silver = Math.floor((value % 10000) / 100);
            return `${gold > 0 ? gold + ' Gold' : ''} ${silver > 0 ? silver + ' Silver' : ''}`.trim();
        }

        // Llamada inicial para obtener los datos
        fetchProfitData();
    </script>
</body>
</html>